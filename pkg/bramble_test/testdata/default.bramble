def fetch_url(url):
    return derivation(name="fetch-url", builder="fetch_url", env={"url": url})


def fetch_busybox():
    return fetch_url("https://brmbl.s3.amazonaws.com/busybox-x86_64.tar.gz")


def busybox():
    return derivation(
        name="busybox",
        builder=fetch_busybox().out + "/busybox-x86_64",
        args=["sh", "./script.sh"],
        sources=files(["./script.sh"]),
        env={"busybox_download": fetch_busybox()},
    )


def script_derivation(name, script, **kwargs):
    bb = busybox()

    PATH = "{}/bin".format(bb.out)
    env = kwargs.get("env", {})
    if kwargs.get("env"):
        kwargs.pop("env")
    env.update(dict(PATH=PATH, busybox=bb.out))
    return derivation(
        name,
        builder=bb.out + "/bin/sh",
        env=env,
        args=["-c", script],
        **kwargs,
    )
